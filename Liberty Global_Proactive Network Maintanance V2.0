#Use local library
.libPaths("/app/RPackageLibrary/R-3.3")

#Package Calls
library(RPostgreSQL)
library(imputeTS)
library(dplyr)
library(data.table)
library(plyr)

#Create DB connection to localhost
drv <- RPostgreSQL::PostgreSQL()
con <- DBI::dbConnect(drv, dbname = 'PNM_CH_SA', user = 'postgres', host = '127.0.0.1', port = 5432, password = 'postgres')

#Reference Data - Contains all probelamtic nodes which are confirmed CPD issue

referenceTest <- DBI::dbGetQuery(con, "SELECT * FROM TEST_CASES.TEST_CASES_REFERENCE_DATA;")

#Node Data set - Filter out the time series data from polling dataset for all probelamtic nodes. The snr_up for each node is calculated by averaging snr_up for each CPE under a node.

NodeData <- DBI::dbGetQuery(con,"SELECT DISTINCT a.node_name, a.hour_stamp, AVG(a.snr_up) FROM TEST_CASES.test_cases_polling_data a, TEST_CASES.TEST_CASES_REFERENCE_DATA b where a.topo_node_type = 'CPE' and a.node_name = b.node_name GROUP by a.node_name, a.hour_stamp ORDER by a.node_name, a.hour_stamp; ")

# CPE Data set - Filter out all CPEs data for all probelamtic nodes from polling dataset

CPEData <- DBI::dbGetQuery(con,"SELECT DISTINCT a.* FROM TEST_CASES.test_cases_polling_data a, TEST_CASES.TEST_CASES_REFERENCE_DATA b where a.topo_node_type = 'CPE' and a.node_name = b.node_name ORDER BY a.node_name, a.hour_stamp; ")

# Close the posgres DB connection

on.exit(dbDisconnect(con))

# Imputing the NA values in the node dataset with Simple moving averages

NodeData <- NodeData[order(NodeData$node_name,NodeData$hour_stamp),]

NodeData <- NodeData %>%
  group_by(node_name) %>%
  mutate(avg_snr_up = na.ma(avg, k = 4, weighting = "simple"))

# Creating the Mac series (src_node_id) for snr_dn

mac_snrdn <- CPEData[,c("node_name", "src_node_id","hour_stamp", "snr_dn")]

# Creating the Mac series (src_node_id) for pathloss

mac_pathloss <- CPEData[,c("node_name", "src_node_id","hour_stamp", "pathloss")]

# Imputing the NA values in the Mac snrdn dataset with Simple moving averages

mac_snrdn <- mac_snrdn[order(mac_snrdn$node_name, mac_snrdn$src_node_id, mac_snrdn$hour_stamp),]

mac_snrdn <- mac_snrdn %>%
  group_by(src_node_id) %>%
  mutate(snr_dn_sma = na.ma(snr_dn, k = 4, weighting = "simple"))

# Imputing the NA values in the Mac pathloss dataset with Simple moving averages

mac_pathloss <- mac_pathloss[order(mac_pathloss$node_name, mac_pathloss$src_node_id, mac_pathloss$hour_stamp),]

mac_pathloss <- mac_pathloss %>%
  group_by(src_node_id) %>%
  mutate(pathloss_sma = na.ma(pathloss, k = 4, weighting = "simple"))

#################### Creating the feature list #####################

#Length of Mac series

mac_len <- ddply(CPEData, .(src_node_id), nrow)
setnames(mac_snrdn_len, "V1", "mac_len")

# Missing Values for snr_dn and pathloss

mac_snrdn_na <- aggregate(snr_dn ~ src_node_id, data=CPEData, function(x) {sum(is.na(x))}, na.action = NULL)
mac_pathloss_na <- aggregate(pathloss ~ src_node_id, data=CPEData, function(x) {sum(is.na(x))}, na.action = NULL)

# Descriptive Stats for snr_dn and pathloss 

mac_stats <- setDT(CPEData)[ , list(snrdn_min=min(snr_dn, na.rm = T), snrdn_max=max(snr_dn, na.rm = T), snrdn_mean=mean(snr_dn, na.rm = T), snrdn_median=median(snr_dn, na.rm = T), snrdn_sd=sd(snr_dn, na.rm = T), pathloss_min=min(pathloss, na.rm = T), pathloss_max=max(pathloss, na.rm = T), pathloss_mean=mean(pathloss, na.rm = T), pathloss_median=median(pathloss, na.rm = T), pathloss_sd=sd(pathloss, na.rm = T)), by= .(src_node_id)]

# Average difference between successive time stamp for non na snr dn values - 

mac_snrdn_tdiff <-  CPEData %>%
  select(src_node_id, hour_stamp, snr_dn)

mac_snrdn_tdiff <- mac_snrdn_tdiff[!is.na(mac_snrdn_tdiff$snr_dn),]

mac_snrdn_tdiff <- mac_snrdn_tdiff[order(mac_snrdn_tdiff$src_node_id, mac_snrdn_tdiff$hour_stamp),]

mac_snrdn_tdiff$snrdn_tdiff <- unlist(tapply(mac_snrdn_tdiff$hour_stamp, INDEX = mac_snrdn_tdiff$src_node_id, FUN = function(x) c(0, diff(as.numeric(x)))))

mac_snrdn_tdiff <- aggregate(tdiff ~ src_node_id, data=mac_snrdn_tdiff, function(x) {mean(x)}, na.action = NULL)

# Average difference between successive time stamp for non na pathloss values - 

mac_pathloss_tdiff <-  CPEData %>%
  select(src_node_id, hour_stamp, pathloss)

mac_pathloss_tdiff <- mac_pathloss_tdiff[!is.na(mac_pathloss_tdiff$pathloss),]

mac_pathloss_tdiff <- mac_pathloss_tdiff[order(mac_pathloss_tdiff$src_node_id, mac_pathloss_tdiff$hour_stamp),]

mac_pathloss_tdiff$pathloss_tdiff <- unlist(tapply(mac_pathloss_tdiff$hour_stamp, INDEX = mac_pathloss_tdiff$src_node_id, FUN = function(x) c(0, diff(as.numeric(x)))))

mac_pathloss_tdiff <- aggregate(tdiff ~ src_node_id, data=mac_pathloss_tdiff, function(x) {mean(x)}, na.action = NULL)
